{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />


<link rel="stylesheet" type="text/css" href="{% static 'css/navbar.css' %}">

<div class="top-navbar">
  <div class="left">
    <div class="hamburger" id="hamburger">
      <i class="fa-solid fa-bars"></i>
    </div>
    <div class="logo">BRITS Helpdesk</div>
  </div>

  

  <div class="nav-right">
    <!-- Notification Bell -->
    <div class="notifications" id="notificationBell">
      <i class="fas fa-bell"></i>
      <span class="badge" id="notificationCount" style="display: none;">0</span>

      <div class="dropdown-menu notifications-dropdown" id="notificationsDropdown">
        <div id="notificationsList">
          <p class="empty">No tickets</p>
        </div>
        <div class="view-all">
          <a href="{% url 'escalated_tickets_list' %}">View all</a>
        </div>
      </div>
    </div>
  


    <div class="user-profile" id="userProfile">
      <div class="profile-trigger">
          {% if user.profile.avatar %}
              <img src="{{ user.profile.avatar.url }}" alt="User Avatar">
          {% else %}
              <!-- Display initials if no avatar is set -->
              <div class="profile-avatar default-avatar">
                  <span class="avatar-initials">
                      {{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}
                  </span>
              </div>
          {% endif %}
          <span>{{ user.get_full_name|default:user.username }}</span>
          <i class="fas fa-chevron-down"></i>
      </div>
      <div class="dropdown-menu">
        <a href="{% url 'profile_view' %}"><i class="fa-solid fa-user"></i>  Profile</a>
        <a href="{% url 'settings' %}"><i class="fa-solid fa-gear"></i>  Settings</a>
        <form id="logout-form" method="post" action="{% url 'logout' %}" style="margin: 0;">
          {% csrf_token %}
          <button type="submit" class="dropdown-link logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const profileViewUrl = "{% url 'profile_view' %}";
  const fetchEscalationsUrl = "{% url 'get_notifications' %}";

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrfToken = getCookie("csrftoken");

  let escalationSocket;

  // ==== Initialize WebSocket ====
  (function () {
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const url = `${wsScheme}://${window.location.host}/ws/escalations/`;
    console.log("Connecting to WebSocket at:", url);

    escalationSocket = new WebSocket(url);
    escalationSocket.onopen = () => {
      console.log("‚úÖ Connected to escalation WebSocket");
    };
    escalationSocket.onclose = () => {
      console.error("‚ùå WebSocket closed unexpectedly");
    };

  escalationSocket.onmessage = (e) => {
  const data = JSON.parse(e.data);
  console.log("üì© WebSocket message received:", data);
  switch (data.type) {
    case "notifications_list":
      if (data.tickets) renderNotifications(data.tickets, data.count);
      break;
    case "ticket_creation":
      console.log("‚û°Ô∏è Ticket creation payload:", data);
      if (data.ticket) handleNewTicket(data.ticket);
      break;
    case "escalation_message":
      if (data.message) showNotification(data.message);
      break;
    case "unassigned_ticket_notification":
      if (data.ticket) handleNewUnassignedTicket(data.ticket);
      break;
    case "ticket_read":
      // Handle read ticket and remove it from the list
      renderNotifications(data.tickets, data.count); // Re-render the notifications list
      break;
    default:
      console.warn("‚ö†Ô∏è Unknown WebSocket event type:", data.type);
  }
};
})();  <!--‚Äì IIFE closed here -->

  // ==== Initial Fetch ====
  fetch(fetchEscalationsUrl)
    .then((r) => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      const ct = r.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        return r.text().then((txt) => {
          throw new Error("Expected JSON, got: " + txt.slice(0, 100));
        });
      }
      return r.json();
    })
    .then((data) => renderNotifications(data.tickets || [], data.count))
    .catch((err) => console.error("Error fetching tickets:", err));

function createNotificationItem(notification) {
  const div = document.createElement("div");
  div.classList.add("notification-item");

  const ticket = notification.ticket;

  const isEsc = ticket.notification_type === "escalated" || ticket.is_escalated === true || (ticket.escalated_at && ticket.escalated_at !== null);
  const isUnassigned = ticket.notification_type === "unassigned";

  let typeLabel = "";
  let badgeClass = "";

  if (isEsc) {
    typeLabel = "Escalated";
    badgeClass = "badge-escalated";
  } else if (isUnassigned) {
    typeLabel = "Unassigned";
    badgeClass = "badge-unassigned";
  } else {
    typeLabel = "New";
    badgeClass = "badge-new";
  }

  const priorityText = typeof ticket.priority === "string" ? ticket.priority : JSON.stringify(ticket.priority);

  div.innerHTML = `
    <a href="/tickets/${ticket.id}/"
       class="dropdown-item"
       data-notification-id="${notification.notification_id}" 
       style="${notification.is_read ? 'opacity: 0.5;' : ''}">
      <div>
        #${ticket.id} - ${ticket.title}<br>
        <small>${priorityText} | ${ticket.escalated_at ? ticket.escalated_at : ticket.created_at}</small>
      </div>
      <span class="badge ${badgeClass}">${typeLabel}</span>
    </a>
  `;

  // Handle click
  div.querySelector("a").addEventListener("click", async function (e) {
    e.preventDefault(); 
    const targetUrl = this.getAttribute("href");

    try {
      await markNotificationRead(notification.notification_id);  
    } catch (err) {
      console.error("Mark read failed, still redirecting:", err);
    }
    window.location.href = targetUrl; 
  });

  return div;
}

function markNotificationRead(notificationId) {
  return fetch(`/notifications/mark_read/${notificationId}/`, {
    method: "POST",
    body: JSON.stringify({ type: "read" }),
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken,
    },
  })
  .then((response) => response.json())
  .then((data) => {
    if (data.success) {
      // Ensure the notification disappears
      const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
      if (notificationItem) {
        notificationItem.parentElement.removeChild(notificationItem);
      }
      updateNotificationCount();
    } else {
      console.error("Failed to mark notification as read.");
    }
  })
  .catch((err) => console.error("Error marking read:", err));
}






// Update notification count after marking as read
function updateNotificationCount() {
  const countEl = document.getElementById("notificationCount");
  let currentCount = parseInt(countEl.textContent || "0", 10);
  if (currentCount > 0) {
    countEl.textContent = currentCount - 1;
  }
  if (currentCount <= 1) {
    countEl.style.display = "none"; 
  }
}

function renderNotifications(tickets, totalCount) {
  const countEl = document.getElementById("notificationCount");
  const listEl = document.getElementById("notificationsList");

  if (!countEl || !listEl) return;

  listEl.innerHTML = "";

  if (!tickets || tickets.length === 0) {
    listEl.innerHTML = `<div class="dropdown-item text-muted empty">No unread tickets</div>`;
    countEl.style.display = "none";
    return;
  }

  // Only show notifications that are unread
  tickets.filter(ticket => !ticket.is_read).forEach((t) => listEl.appendChild(createNotificationItem(t)));

  countEl.textContent = totalCount;
  countEl.style.display = "inline-block";
}


  function handleNewTicket(ticket) {
  const existing = document.querySelector(`[data-ticket-id="${ticket.id}"]`);
  if (existing) return;

  const countEl = document.getElementById("notificationCount");
  const listEl = document.getElementById("notificationsList");
  if (!countEl || !listEl) return;

  const emptyMsg = document.querySelector(".empty");
  if (emptyMsg) emptyMsg.remove();

  const notification = {
    notification_id: `tmp-${ticket.id}`,
    is_read: false,
    notification_type: ticket.notification_type || "new",
    ticket: ticket,
  };

  listEl.prepend(createNotificationItem(notification));

  const items = listEl.querySelectorAll(".notification-item");
  if (items.length > 5) listEl.removeChild(items[items.length - 1]);

  const current = parseInt(countEl.textContent || "0", 10);
  countEl.textContent = isNaN(current) ? 1 : current + 1;
  countEl.style.display = "inline-block";
}

  function handleNewUnassignedTicket(ticket) {
  const countEl = document.getElementById("notificationCount");
  const listEl = document.getElementById("notificationsList");
  if (!countEl || !listEl) return;

  const emptyMsg = document.querySelector(".empty");
  if (emptyMsg) emptyMsg.remove();

  const notification = {
    notification_id: `tmp-${ticket.id}`, 
    is_read: false,
    notification_type: "unassigned",
    ticket: ticket,
  };

  listEl.prepend(createNotificationItem(notification));

  const items = listEl.querySelectorAll(".notification-item");
  if (items.length > 5) listEl.removeChild(items[items.length - 1]);

  const current = parseInt(countEl.textContent || "0", 10);
  countEl.textContent = isNaN(current) ? 1 : current + 1;
  countEl.style.display = "inline-block";
}


  // ==== Show Text Notification ====
  function showNotification(message) {
    const listEl = document.getElementById("notificationsList");
    if (!listEl) return;

    const text = typeof message === "string" ? message : JSON.stringify(message);
    const div = document.createElement("div");
    div.classList.add("notification-item", "new-message");
    div.innerHTML = `<div class="dropdown-item">üîî ${text}</div>`;
    listEl.prepend(div);
    setTimeout(() => {
      div.remove();
    }, 10000);
  }

  // ==== Dropdown Toggle ====
  const bell = document.getElementById("notificationBell");
  const menu = document.getElementById("notificationsDropdown");
  if (bell && menu) {
    bell.addEventListener("click", () => menu.classList.toggle("show"));

    document.addEventListener("click", (e) => {
      if (!bell.contains(e.target)) {
        menu.classList.remove("show");
      }
    });
  }
</script>
<script src="{% static 'js/ticketing_dashboard.js' %}"></script>