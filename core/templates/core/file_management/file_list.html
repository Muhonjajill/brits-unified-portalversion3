{% extends "files_base.html" %}
{% load static %}

{% block title %}File Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/file_list.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="page-title"><i class="fa-solid fa-folder-open"></i> File Management</h2>

  <!-- Category Buttons -->
  <div class="category-nav">
    <a href="{% url 'upload_file' %}" class="upload-button">➕ Upload New File</a>
    <a href="{% url 'file_list' %}" class="{% if not active_category %}active{% endif %}">All</a>
    {% for category in categories %}
      <a href="{% url 'file_list_by_category' category.name %}" class="{% if category.name == active_category %}active{% endif %}">{{ category.name }}</a>
    {% endfor %}
  </div>
  
  <h3 class="section-subtitle">
      {% if recent %}
          Recent Files
      {% elif file_type %}
          Files of type: {{ file_type|slice:"1:"|upper }}
      {% elif active_category %}
          {{ active_category }}
      {% else %}
          All Files
      {% endif %}
  </h3>

  <div class="file-grid-header animate-fadein">
    <span>NAME</span>
    <span>SIZE</span>
    <span>CLASSIFICATION</span>
    <span>PREVIEW</span>
    <span>DOWNLOAD</span>
    <span class="delete-header">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="vertical-align:-3px;">
        <path d="M7 9V15M10 9V15M13 9V15M4 6H16M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2C10.5304 2 11.0391 2.21071 11.4142 2.58579C11.7893 2.96086 12 3.46957 12 4V6M19 6V18C19 18.5304 18.7893 19.0391 18.4142 19.4142C18.0391 19.7893 17.5304 20 17 20H3C2.46957 20 1.96086 19.7893 1.58579 19.4142C1.21071 19.0391 1 18.5304 1 18V6H19Z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      DELETE
    </span>
  </div>

  <div class="file-grid animate-fadein">
    {% for file in files %}
    {% if file.access_level != 'confidential' or file.uploaded_by == request.user or request.user.is_superuser %}
      <div class="file-row">
        <div class="file-name">
          <input type="hidden" id="file-uploaded-by-{{ file.id }}" value="{{ file.uploaded_by.id }}">
          {% if ".pdf" in file.file.name|lower %}
            <img src="{% static 'icons/pdf.png' %}" alt="PDF Icon" />
          {% elif ".docx" in file.file.name|lower %}
            <img src="{% static 'icons/docx.png' %}" alt="DOCX Icon" />
          {% elif ".jpg" in file.file.name|lower or ".png" in file.file.name|lower %}
            <img src="{{ file.file.url }}" alt="Image" />
          {% elif ".xlsx" in file.file.name|lower %}
            <img src="{% static 'icons/xlsx.png' %}" alt="Excel Icon" />
          {% elif ".txt" in file.file.name|lower %}
            <img src="{% static 'icons/text.png' %}" alt="Text Icon" />
          {% elif ".csv" in file.file.name|lower %}
            <img src="{% static 'icons/csv.png' %}" alt="CSV Icon" />
          {% elif ".xml" in file.file.name|lower %}
            <img src="{% static 'icons/xml.png' %}" alt="XML Icon" />
          {% elif ".ppt" in file.file.name|lower %}
            <img src="{% static 'icons/ppt.png' %}" alt="PPT Icon" />
          {% else %}
            <img src="{% static 'icons/file.png' %}" alt="File Icon" />
          {% endif %}
          <div class="file-title-group">
            <span class="file-title">{{ file.title|default:"No title available" }}</span>
            <small class="file-description">{{ file.description|truncatechars:60 }}</small>
          </div>
        </div>
        <div>{{ file.file.size|filesizeformat }}</div>
        <div><span class="tag {% if file.access_level == 'confidential' %}private{% else %}{{ file.access_level }}{% endif %}">{{ file.access_level|title }}</span></div>

        {% if file.access_level == 'restricted' and file.id %}
          <!-- Modal for passcode -->
          <div id="passcode-modal-{{ file.id }}" class="passcode-modal">
            <div class="passcode-modal-content">
              <form autocomplete="off" onsubmit="return false;">
                <span class="close" onclick="closePasscodeModal({{ file.id }})">&times;</span>
                <h3>Enter Passcode to Access File</h3>
                
                <!-- Passcode input -->
                <input type="password" name="passcode" id="passcode-{{ file.id }}" placeholder="Enter Passcode" autocomplete="off" />
                
                <!-- Conditional section for file owner actions -->
                {% if file.uploaded_by == request.user %}
                  <div class="form-group">
                    <label for="allowed-actions" class="form-label">Allowed Actions:</label>
                    <div class="form-check">
                      <label class="checkbox-label">
                        <input type="checkbox" id="allow_preview_{{ file.id }}" {% if file.allow_preview %}checked{% endif %} class="form-check-input">
                        Preview
                      </label>
                    </div>
                    <div class="form-check">
                      <label class="checkbox-label">
                        <input type="checkbox" id="allow_download_{{ file.id }}" {% if file.allow_download %}checked{% endif %} class="form-check-input">
                        Download
                      </label>
                    </div>
                  </div>

                  <div class="action-buttons">
                    <button type="button" onclick="updatePasscode({{ file.id }})" class="btn btn-reset-passcode">
                      Set / Reset Passcode
                    </button>
                  </div>
                {% endif %}

                
                <!-- Submit button for the passcode -->
                <button type="button" onclick="checkPasscode({{ file.id }})">Submit</button>
                
                <!-- Error message -->
                <p id="passcode-error-{{ file.id }}" style="color:red; display:none;">Incorrect passcode</p>
              </form>
            </div>
          </div>
        {% endif %}

        <div>
          {% if file.id %}
            {% if file.access_level == "restricted" %}
              <a href="#" onclick="showPasscodeModal({{ file.id }}, '{% url 'preview_file' file.id %}', 'preview'); return false;" class="btn preview-link">Preview</a>
            {% else %}
              <a href="{% url 'preview_file' file.id %}" class="btn preview-link">Preview</a>
            {% endif %}
          {% else %}
            <span>Preview Unavailable</span>
          {% endif %}
        </div>

        <div>
          {% if file.id %}
            {% if file.access_level == "restricted" %}
              <a href="#" onclick="showPasscodeModal({{ file.id }}, '{% url 'download_file' file.id %}', 'download'); return false;" class="btn download-link">Download</a>
            {% else %}
              <a href="{% url 'download_file' file.id %}" class="btn download-link">Download</a>
            {% endif %}
          {% else %}
            <span>Download Unavailable</span>
          {% endif %}
        </div>


        {% if file.uploaded_by == request.user or request.user.is_superuser %}
        <div>
          <form method="post" action="{% url 'delete_file' file.id %}" id="delete-form-{{ file.id }}">
            {% csrf_token %}
            <button 
              type="button" 
              class="btn delete-link btn-delete-file"
              data-file-id="{{ file.id }}"
              data-file-title="{{ file.title|default:'No title available' }}"
              data-file-size="{{ file.file.size|filesizeformat }}"
              data-file-access="{{ file.access_level|title }}">
              Delete
            </button>
          </form>
        </div>
        {% else %}
        <div><span style="color:#999; font-size:0.8rem;">Not allowed</span></div>
        {% endif %}
      </div>
      {% endif %}
    {% empty %}
      <div class="file-row empty">No files available.</div>
    {% endfor %}
  </div>
</div>

<div class="pagination">
  <span class="step-links">
    {% if files.has_previous %}
      <a href="?page=1{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">&laquo; first</a>
      <a href="?page={{ files.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">previous</a>
    {% endif %}
    <span class="current">Page {{ files.number }} of {{ files.paginator.num_pages }}.</span>
    {% if files.has_next %}
      <a href="?page={{ files.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">next</a>
      <a href="?page={{ files.paginator.num_pages }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">last &raquo;</a>
    {% endif %}
  </span>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="passcode-modal">
  <div class="passcode-modal-content delete-confirm-modal">
    <span class="close" onclick="closeDeleteModal()">&times;</span>
    <div class="delete-modal-header">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Confirm File Deletion</h3>
    </div>
    <div class="delete-modal-body">
      <p>Are you sure you want to permanently delete this file?</p>
      
      <div class="file-details-box">
        <div class="detail-row">
          <strong>File Name:</strong>
          <span id="delete-file-title"></span>
        </div>
        <div class="detail-row">
          <strong>Size:</strong>
          <span id="delete-file-size"></span>
        </div>
        <div class="detail-row">
          <strong>Access Level:</strong>
          <span id="delete-file-access"></span>
        </div>
      </div>

      <p class="text-danger">
        <i class="fas fa-exclamation-circle"></i> This action cannot be undone!
      </p>
    </div>
    <div class="delete-modal-footer">
      <button type="button" class="btn btn-cancel" onclick="closeDeleteModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button type="button" class="btn btn-confirm-delete" id="confirmDeleteBtn">
        <i class="fas fa-trash-alt"></i> Delete File
      </button>
    </div>
  </div>
</div>

<!-- Notification Modals -->
<!-- Success Modal -->
<div id="successNotificationModal" class="notification-modal">
  <div class="notification-modal-content">
    <span class="close" onclick="closeSuccessNotification()">&times;</span>
    <div class="notification-modal-header success-header">
      <i class="fas fa-check-circle"></i>
      <h3 id="successNotificationTitle">Success</h3>
    </div>
    <div class="notification-modal-body">
      <p id="successNotificationMessage"></p>
    </div>
    <div class="notification-modal-footer">
      <button type="button" class="btn-notification-ok" onclick="closeSuccessNotification()">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="errorNotificationModal" class="notification-modal">
  <div class="notification-modal-content">
    <span class="close" onclick="closeErrorNotification()">&times;</span>
    <div class="notification-modal-header error-header">
      <i class="fas fa-exclamation-circle"></i>
      <h3 id="errorNotificationTitle">Error</h3>
    </div>
    <div class="notification-modal-body">
      <p id="errorNotificationMessage"></p>
    </div>
    <div class="notification-modal-footer">
      <button type="button" class="btn-notification-ok error-btn" onclick="closeErrorNotification()">
        <i class="fas fa-times"></i> OK
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const validatedFiles = {{ validated_files|default:"[]"|safe }};
let pendingRedirect = null;
let deleteFormToSubmit = null;

// Notification Modal Functions
function showSuccessNotification(title, message) {
  document.getElementById('successNotificationTitle').textContent = title || 'Success';
  document.getElementById('successNotificationMessage').textContent = message;
  document.getElementById('successNotificationModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeSuccessNotification() {
  document.getElementById('successNotificationModal').classList.remove('show');
  document.body.style.overflow = '';
}

function showErrorNotification(title, message) {
  document.getElementById('errorNotificationTitle').textContent = title || 'Error';
  document.getElementById('errorNotificationMessage').textContent = message;
  document.getElementById('errorNotificationModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeErrorNotification() {
  document.getElementById('errorNotificationModal').classList.remove('show');
  document.body.style.overflow = '';
}

// Close modals when clicking outside
window.onclick = function(event) {
  const successModal = document.getElementById('successNotificationModal');
  const errorModal = document.getElementById('errorNotificationModal');
  
  if (event.target === successModal) {
    closeSuccessNotification();
  }
  if (event.target === errorModal) {
    closeErrorNotification();
  }
};

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(cookie => {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
    });
  }
  return cookieValue;
}

function showPasscodeModal(fileId, targetUrl, action) {
  // Ensure the element exists before accessing its value
  const uploaderElement = document.getElementById(`file-uploaded-by-${fileId}`);
  if (!uploaderElement) {
    console.error("Uploader element not found for file ID:", fileId);
    return false; 
  }

  const isUploader = uploaderElement.value === '{{ request.user.id }}';

  // Always show the modal to the uploader
  if (isUploader) {
    const modal = document.getElementById('passcode-modal-' + fileId);
    modal.classList.add('show');
    document.body.style.overflow = 'hidden'; 
    pendingRedirect = { fileId, targetUrl, action };
    return false;
  }

  // Check for preview or download permission
  const allowPreviewCheckbox = document.getElementById(`allow_preview_${fileId}`);
  const allowDownloadCheckbox = document.getElementById(`allow_download_${fileId}`);

  if (allowPreviewCheckbox && allowDownloadCheckbox) {
    const allowPreview = allowPreviewCheckbox.checked;
    const allowDownload = allowDownloadCheckbox.checked;

    if (action === 'preview' && !allowPreview) {
      // ✅ Use modal instead of alert
      showErrorNotification('Preview Not Allowed', 'This file cannot be previewed.');
      return false;
    }

    if (action === 'download' && !allowDownload) {
      // ✅ Use modal instead of alert
      showErrorNotification('Download Not Allowed', 'This file cannot be downloaded.');
      return false;
    }
  }

  if (validatedFiles.includes(fileId)) {
    window.location.href = targetUrl;
    return false;
  }

  const modal = document.getElementById('passcode-modal-' + fileId);
  if (!modal) {
    window.location.href = targetUrl;
    return false;
  }

  modal.classList.add('show');
  pendingRedirect = { fileId, targetUrl, action };
  return false;
}


function closePasscodeModal(fileId) {
  const modal = document.getElementById('passcode-modal-' + fileId);
  if (modal) modal.classList.remove('show');
  document.body.style.overflow = '';  
  pendingRedirect = null;
}

function checkPasscode(fileId) {
  const passcode = document.getElementById(`passcode-${fileId}`).value;
  const errorElement = document.getElementById(`passcode-error-${fileId}`);
  const csrftoken = getCookie('csrftoken');

  fetch(`/validate-passcode/${fileId}/`, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken },
    body: new URLSearchParams({ passcode })
  })
  .then(r=>r.json())
  .then(data=>{
    if(!data.success){ errorElement.style.display='block'; return; }
    validatedFiles.push(fileId);
    const { targetUrl, action } = pendingRedirect;
    closePasscodeModal(fileId);
    window.location.href = targetUrl;
  })
  .catch(err=>{ 
    console.error(err); 
    // ✅ Use modal instead of alert
    showErrorNotification('Validation Error', 'Failed to validate passcode. Please try again.');
  });
}

function updatePasscode(fileId){
  const passcode = document.getElementById(`passcode-${fileId}`).value;
  const allowPreview = document.getElementById(`allow_preview_${fileId}`).checked;
  const allowDownload = document.getElementById(`allow_download_${fileId}`).checked;
  const csrftoken = getCookie('csrftoken');

  fetch(`/update-passcode/${fileId}/`, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken },
    body: new URLSearchParams({ passcode, allow_preview: allowPreview, allow_download: allowDownload })
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.success){ 
      // ✅ Use modal instead of alert
      showSuccessNotification('Update Successful', 'Passcode & permissions updated successfully!');
      closePasscodeModal(fileId); 
    } else {
      // ✅ Use modal instead of alert
      showErrorNotification('Update Failed', 'Failed to update passcode/permissions. Please try again.');
    }
  })
  .catch(err=>{ 
    console.error(err); 
    // ✅ Use modal instead of alert
    showErrorNotification('Update Error', 'Failed to update passcode. Please try again.');
  });
}

// Delete confirmation modal functions
function showDeleteModal(fileId, fileTitle, fileSize, fileAccess) {
  deleteFormToSubmit = document.getElementById('delete-form-' + fileId);
  
  document.getElementById('delete-file-title').textContent = fileTitle;
  document.getElementById('delete-file-size').textContent = fileSize;
  document.getElementById('delete-file-access').textContent = fileAccess;
  
  const modal = document.getElementById('deleteConfirmModal');
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
  const modal = document.getElementById('deleteConfirmModal');
  modal.classList.remove('show');
  document.body.style.overflow = '';
  deleteFormToSubmit = null;
}

// Attach delete button listeners
document.addEventListener('DOMContentLoaded', function() {
  const deleteButtons = document.querySelectorAll('.btn-delete-file');
  
  deleteButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const fileId = this.dataset.fileId;
      const fileTitle = this.dataset.fileTitle;
      const fileSize = this.dataset.fileSize;
      const fileAccess = this.dataset.fileAccess;
      
      showDeleteModal(fileId, fileTitle, fileSize, fileAccess);
    });
  });

  // Confirm delete button
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteFormToSubmit) {
      deleteFormToSubmit.submit();
    }
  });

  // Highlight file if needed
  const highlightId = "{{ highlight_file_id }}";
  if (highlightId) {
      const el = document.getElementById("file-" + highlightId);
      if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
  }
});
</script>
{% endblock %}
