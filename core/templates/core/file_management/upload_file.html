{% extends "files_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/upload_file.css' %}">
{% endblock %}

{% block title %}Upload File{% endblock %} 

{% block content %}
{% if perms.core.add_file %}
<div class="upload-container">
    <h2>üìÅ Upload a New File</h2>

    <form id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_title">Title</label>
            {{ form.title }}
        </div>
        <div class="form-group">
            <label for="id_description">Description</label>
            {{ form.description }}
        </div>
        <div class="form-group">
            <label for="id_category">Category</label>
            {{ form.category }}
        </div>
        <div class="form-group">
            <label for="id_access_level">Access Level</label>
            {{ form.access_level }}
        </div>
        <div class="form-group">
            <label for="id_file">File</label>
            {{ form.file }}
        </div>

        <input type="submit" value="Upload File" class="btn btn-primary">
    </form>
</div>

<!-- Passcode modal -->
<div id="passcode-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Set Passcode for Restricted File</h2>

        <form id="passcode-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_passcode">Passcode</label>
                {{ form.passcode }}
            </div>
            <button type="button" class="btn btn-primary" onclick="submitPasscode()">Set Passcode</button>
        </form>
    </div>
</div>

<!-- Success Confirmation Modal -->
<div id="success-modal" class="modal success-modal">
    <div class="modal-content">
        <span class="close" onclick="closeSuccessModal()">&times;</span>
        <div class="success-modal-header">
            <i class="fas fa-check-circle"></i>
            <h2>File Uploaded Successfully!</h2>
        </div>
        <div class="success-modal-body">
            <p>Your file has been uploaded and is now available in the file list.</p>
            <div class="file-success-details" id="success-file-details">
                <!-- File details will be populated here -->
            </div>
        </div>
        <div class="success-modal-footer">
            <button type="button" class="btn-success-ok" onclick="redirectToFileList()">
                <i class="fas fa-check"></i> View Files
            </button>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-warning">
    üö´ You do not have permission to upload files.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const uploadForm = document.getElementById("upload-form");
    const accessLevelSelect = document.getElementById("id_access_level");
    const passcodeModal = document.getElementById("passcode-modal");
    const successModal = document.getElementById("success-modal");
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let uploadedFileId = null;
    let uploadedFileData = null;

    passcodeModal.classList.remove("show");
    successModal.classList.remove("show");

    // AJAX upload
    uploadForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const formData = new FormData(uploadForm);

        fetch(uploadForm.action || window.location.href, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedFileId = data.file_id;
                uploadedFileData = data;
                
                if (accessLevelSelect.value === "restricted") {
                    passcodeModal.classList.add("show");
                    document.body.style.overflow = 'hidden';
                } else {
                    showSuccessModal(data);
                }
            } else {
                alert("‚ùå Upload failed.");
            }
        })
        .catch(error => {
            console.error(error);
            alert("‚ùå Error uploading file.");
        });
    });

    // Show success modal
    window.showSuccessModal = function(data) {
        const detailsContainer = document.getElementById('success-file-details');
        
        // Build file details HTML
        let detailsHTML = '';
        if (data.file_title) {
            detailsHTML += `<p><strong>Title:</strong> ${data.file_title}</p>`;
        }
        if (data.file_category) {
            detailsHTML += `<p><strong>Category:</strong> ${data.file_category}</p>`;
        }
        if (data.file_access_level) {
            detailsHTML += `<p><strong>Access Level:</strong> ${data.file_access_level}</p>`;
        }
        
        detailsContainer.innerHTML = detailsHTML || '<p>File uploaded successfully!</p>';
        
        successModal.classList.add("show");
        document.body.style.overflow = 'hidden';
    };

    // Close success modal
    window.closeSuccessModal = function() {
        successModal.classList.remove("show");
        document.body.style.overflow = '';
    };

    // Redirect to file list
    window.redirectToFileList = function() {
        window.location.href = "{% url 'file_list' %}";
    };

    // Passcode AJAX submit
    window.submitPasscode = function() {
        const passcode = document.getElementById("id_passcode").value;

        fetch(`/update-passcode/${uploadedFileId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: "passcode=" + encodeURIComponent(passcode)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal();
                showSuccessModal(uploadedFileData);
            } else {
                alert("‚ùå Failed to set passcode.");
            }
        })
        .catch(error => {
            console.error(error);
            alert("‚ùå Error updating passcode.");
        });
    }

    // Close passcode modal
    window.closeModal = function() {
        passcodeModal.classList.remove("show");
        document.body.style.overflow = '';
    };

    // Prevent accidental close if restricted
    window.addEventListener("click", function(event) {
        if (event.target === passcodeModal) {
            if (accessLevelSelect.value === "restricted") {
                alert("‚ö†Ô∏è Passcode required for restricted files.");
            } else {
                passcodeModal.classList.remove("show");
                document.body.style.overflow = '';
            }
        }
        
        // Allow closing success modal by clicking outside
        if (event.target === successModal) {
            closeSuccessModal();
        }
    });
});
</script>
{% endblock %}
