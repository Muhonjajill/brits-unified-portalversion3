{% extends "base.html" %}
{% load static %}

{% block title %}Tickets{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tickets.css' %}">
{% endblock %}

{% block content %}
<div class="tickets-container">
  <div class="section-header">
    <h2><i class="fa-solid fa-ticket"></i> Tickets</h2>
    <p>This is the ticket management interface. You can view, filter, and manage support tickets here.</p>
  </div>

  <div class="ticket-actions">
    <button class="btn btn-primary" id="create_ticket">Create New Ticket</button>
    <form method="get" class="search-form">
      <input type="text" name="search" class="ticket-search" value="{{ search_query }}" placeholder="Search tickets..." />
      <button type="submit" class="btn btn-sm btn-primary">Search</button>
      <a
        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}export=excel"
        class="btn btn-success"
      >
        <i class="fa-solid fa-file-excel"></i> Export
      </a>
    </form>
  </div>

  <form method="get" class="status-filter-form">
    <select name="status" class="form-control" onchange="this.form.submit()">
        <option value="">All Tickets</option>
        <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
        <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
        <option value="escalated" {% if status_filter == 'escalated' %}selected{% endif %}>Escalated</option>
    </select>
  </form>

  <div class="ticket-table-wrapper">
    <table class="ticket-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Terminal</th>
          <th>Issue Raised</th>
          <th>Status</th>
          <!--<th>Priority</th>-->
          <th>Assigned To</th>
          <th>View Ticket</th>
          {% if request.user.is_superuser %}
          <th>Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for ticket in tickets %}
        <tr onclick="window.location='{% url 'ticket_detail' ticket.id %}'" style="cursor:pointer;">
          <td>{{ ticket.id }}</td>
          <td>{{ ticket.terminal.branch_name }}</td>
          <td>
            {{ ticket.title }}
            {% if ticket.is_escalated %}
              <span class="badge-escalated">Escalated</span>
            {% endif %}
          </td>
          <td>
            {% if ticket.status == "closed" %}
              <span class="status-closed">{{ ticket.get_status_display }}</span>
            {% else %}
              <span class="status-{{ ticket.priority|lower }}">{{ ticket.get_status_display }}</span>
            {% endif %}
          </td>
          <!--<td><span class="badge badge-{{ ticket.priority }}">{{ ticket.get_priority_display }}</span></td>-->
          <td>
            {% if ticket.assigned_to %}
              {{ ticket.assigned_to.username }}
            {% else %}
              <span class="text-muted">Unassigned</span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'ticket_detail' ticket.id %}" class="view-link" onclick="event.stopPropagation();">View</a>
          </td>
          <td>
            {% if request.user.is_superuser %}
            <a href="{% url 'delete_ticket' ticket.id %}" 
               class="view-link text-danger"
               onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this ticket?');">
              Remove
            </a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8">No tickets found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="pagination">
      <span class="step-links">
        {% if tickets.has_previous %}
          <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&laquo; First</a>
          <a href="?page={{ tickets.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
        {% endif %}

        <span class="current">
          Page {{ tickets.number }} of {{ tickets.paginator.num_pages }}
        </span>

        {% if tickets.has_next %}
          <a href="?page={{ tickets.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
          <a href="?page={{ tickets.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Last &raquo;</a>
        {% endif %}
      </span>
    </div>  
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    const ticketBtn = document.getElementById('create_ticket');
    if (ticketBtn){
      ticketBtn.addEventListener('click', function(){
        window.location.href = "{% url 'create_ticket' %}";
      });
    }
  });
</script>
<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
{% endblock %}
