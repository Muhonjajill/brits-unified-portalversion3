{% extends "base.html" %}
{% load static %}

{% block title %}Customers{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customers.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">
  <h2><i class="fas fa-users"></i> Customers</h2>
  <p>Manage customer records here.</p>

  <!-- Upload Form -->
  <div class="page-header-actions">
    <form method="POST" enctype="multipart/form-data" class="upload-form">
      {% csrf_token %}
      <label for="file">
        <i class="fas fa-file-csv"></i> Upload Customer CSV:
      </label>
      <input type="file" name="file" id="file" accept=".csv" required>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-upload"></i> Upload
      </button>
    </form>
    <a href="{% url 'create_customer' %}" class="btn btn-danger">
      <i class="fas fa-plus"></i> New Customer
    </a>
  </div>

  <!-- Messages -->
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="alert alert-{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Table of customers -->
  <div class="table-responsive">
    <table class="ticket-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer Name</th>
          <th>Actions</th> 
        </tr>
      </thead>
      <tbody>
      {% for customer in customers %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>
          <a href="{% url 'customer_terminals' customer.id %}">
            <i class="fas fa-building"></i> {{ customer.name }}
          </a>
        </td>
        <td>
          <a href="#" 
             class="view-link delete-customer-btn"
             data-customer-id="{{ customer.id }}"
             data-customer-name="{{ customer.name }}"
             data-delete-url="{% url 'delete_customer' customer.id %}">
            <i class="fas fa-trash"></i> Remove
          </a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3" style="text-align: center; color: #6c757d; padding: 20px;">
          No customers found.
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  {% if customers.has_other_pages %}
  <div class="pagination">
    <span class="page-links">
      {% if customers.has_previous %}
        <a href="?page=1">&laquo; First</a>
        <a href="?page={{ customers.previous_page_number }}">Previous</a>
      {% endif %}
      
      <span class="current-page">Page {{ customers.number }} of {{ customers.paginator.num_pages }}</span>

      {% if customers.has_next %}
        <a href="?page={{ customers.next_page_number }}">Next</a>
        <a href="?page={{ customers.paginator.num_pages }}">Last &raquo;</a>
      {% endif %}
    </span>
  </div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <h3>Confirm Deletion</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this customer?</p>
      <p><strong id="modalCustomerName"></strong></p>
      <p>This action cannot be undone and will also remove all associated terminals and tickets.</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" id="cancelDelete">Cancel</button>
      <button class="modal-btn modal-btn-confirm" id="confirmDelete">Delete Customer</button>
    </div>
  </div>
</div>

<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Delete Modal Functionality
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const modalCustomerName = document.getElementById('modalCustomerName');
    let deleteUrl = '';

    // Add click event to all delete buttons
    document.querySelectorAll('.delete-customer-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const customerName = this.getAttribute('data-customer-name');
        deleteUrl = this.getAttribute('data-delete-url');
        
        modalCustomerName.textContent = customerName;
        deleteModal.classList.add('active');
      });
    });

    // Cancel button
    cancelDeleteBtn.addEventListener('click', function() {
      deleteModal.classList.remove('active');
      deleteUrl = '';
    });

    // Confirm delete button
    confirmDeleteBtn.addEventListener('click', function() {
      if (deleteUrl) {
        window.location.href = deleteUrl;
      }
    });

    // Close modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
        deleteUrl = '';
      }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && deleteModal.classList.contains('active')) {
        deleteModal.classList.remove('active');
        deleteUrl = '';
      }
    });
  });
</script>
{% endblock %}
