{% extends "base.html" %}
{% load static %}

{% block title %}Units{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/units.css' %}">
{% endblock %}

{% block content %}
<br>
<div class="page-container">
  <h2><i class="fas fa-cube"></i> Units</h2>
  <p>Manage unit information here.</p>

  <form method="post" action="{% url 'units' %}" class="unit-form">
    {% csrf_token %}
    <input type="text" name="name" placeholder="Unit Name" required>
    <input type="text" name="description" placeholder="Description" required>
    <button type="submit" class="btn">
      <i class="fas fa-plus-circle"></i> Add Unit
    </button>
  </form>

  <div class="table-responsive">
    {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ message }}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <table class="unit-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for unit in page_obj %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ unit.name }}</td>
          <td>{{ unit.description }}</td>
          <td>
            <a href="#" 
               class="view-link delete-unit-btn"
               data-unit-id="{{ unit.id }}"
               data-unit-name="{{ unit.name }}"
               data-delete-url="{% url 'delete_unit' unit.id %}">
              <i class="fas fa-trash-alt"></i> Remove
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="text-align: center; color: #6c757d; padding: 20px;">
            No units added yet.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination Links -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
      <span class="step-links">
        {% if page_obj.has_previous %}
          <a href="?page=1"><i class="fas fa-angle-double-left"></i> First</a>
          <a href="?page={{ page_obj.previous_page_number }}"><i class="fas fa-angle-left"></i> Previous</a>
        {% endif %}

        <span class="current">
          <i class="fas fa-file-alt"></i> Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}">Next <i class="fas fa-angle-right"></i></a>
          <a href="?page={{ page_obj.paginator.num_pages }}">Last <i class="fas fa-angle-double-right"></i></a>
        {% endif %}
      </span>
    </div>
    {% endif %}
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <h3>Confirm Deletion</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this unit?</p>
      <p><strong id="modalUnitName"></strong></p>
      <p>This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" id="cancelDelete">Cancel</button>
      <button class="modal-btn modal-btn-confirm" id="confirmDelete">Delete Unit</button>
    </div>
  </div>
</div>

<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Delete Modal Functionality
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const modalUnitName = document.getElementById('modalUnitName');
    let deleteUrl = '';

    // Add click event to all delete buttons
    document.querySelectorAll('.delete-unit-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const unitName = this.getAttribute('data-unit-name');
        deleteUrl = this.getAttribute('data-delete-url');
        
        modalUnitName.textContent = unitName;
        deleteModal.classList.add('active');
      });
    });

    // Cancel button
    cancelDeleteBtn.addEventListener('click', function() {
      deleteModal.classList.remove('active');
      deleteUrl = '';
    });

    // Confirm delete button
    confirmDeleteBtn.addEventListener('click', function() {
      if (deleteUrl) {
        window.location.href = deleteUrl;
      }
    });

    // Close modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
        deleteUrl = '';
      }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && deleteModal.classList.contains('active')) {
        deleteModal.classList.remove('active');
        deleteUrl = '';
      }
    });
  });
</script>
{% endblock %}
