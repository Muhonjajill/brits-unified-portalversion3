{% extends "base.html" %}
{% load static %}

{% block title %}Regions{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/regions.css' %}">
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<br>
<div class="page-container">
  <div class="header-section">
    <h2><i class="fas fa-globe-americas"></i> Regions Management</h2>
    <p>Organize and manage your regional infrastructure. Click on any region to explore its zones and terminals.</p>
  </div>

  <form method="post" action="{% url 'add_region' %}" class="region-form">
    {% csrf_token %}
    <input type="text" name="region_name" placeholder="Enter new region name..." required>
    <button type="submit" class="btn">
      <i class="fas fa-plus-circle"></i> Add Region
    </button>
  </form>

  <div class="table-responsive">
    {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ message }}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <table class="region-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Region Name</th>
          <th>Zones & Terminals</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for region in regions %}
        <tr data-region-id="{{ region.id }}">
          <td><strong>{{ forloop.counter }}</strong></td>
          <td>
            <a href="#" class="region-link" data-region-id="{{ region.id }}">
              <i class="fas fa-map-marked-alt"></i> {{ region.name }}
            </a>
          </td>
          <td>
            <div id="zones-{{ region.id }}" class="zones-container" style="display: none;">
              <div class="zones-loading">
                <i class="fas fa-spinner fa-spin"></i> Loading zones...
              </div>
            </div>
          </td>
          <td>
            <a href="#" 
               class="view-link delete-region-btn"
               data-region-id="{{ region.id }}"
               data-region-name="{{ region.name }}"
               data-delete-url="{% url 'delete_region' region.id %}">
              <i class="fas fa-trash-alt"></i> Remove
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="text-align: center; padding: 3rem;">
            <i class="fas fa-inbox" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
            <p style="color: #6c757d; font-size: 1.1rem;">No regions found. Add your first region above!</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  {% if regions.has_other_pages %}
  <div class="pagination">
    <span class="page-links">
      {% if regions.has_previous %}
        <a href="?page=1"><i class="fas fa-angle-double-left"></i> First</a>
        <a href="?page={{ regions.previous_page_number }}"><i class="fas fa-angle-left"></i> Previous</a>
      {% endif %}
      
      <span class="current-page">
        <i class="fas fa-file-alt"></i> Page {{ regions.number }} of {{ regions.paginator.num_pages }}
      </span>

      {% if regions.has_next %}
        <a href="?page={{ regions.next_page_number }}">Next <i class="fas fa-angle-right"></i></a>
        <a href="?page={{ regions.paginator.num_pages }}">Last <i class="fas fa-angle-double-right"></i></a>
      {% endif %}
    </span>
  </div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-modal-overlay" id="deleteModal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <h3>Confirm Deletion</h3>
    </div>
    <div class="delete-modal-body">
      <p>Are you sure you want to delete this region?</p>
      <p><strong id="modalRegionName"></strong></p>
      <p>This action cannot be undone and will affect all associated zones and terminals.</p>
    </div>
    <div class="delete-modal-footer">
      <button class="delete-modal-btn delete-modal-btn-cancel" id="cancelDelete">Cancel</button>
      <button class="delete-modal-btn delete-modal-btn-confirm" id="confirmDelete">Delete Region</button>
    </div>
  </div>
</div>

<!-- Enhanced Modal for Terminals -->
<div id="terminalsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">
        <i class="fas fa-desktop"></i> Terminals in Zone
      </h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <div id="terminalsLoading" class="loading">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 2.5rem; color: #667eea;"></i>
        <p style="margin-top: 1rem;">Loading terminals...</p>
      </div>
      <div id="terminalsList" style="display: none;"></div>
    </div>
  </div>
</div>

<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('terminalsModal');
    const closeBtn = modal.querySelector('.close');
    const modalTitle = document.getElementById('modalTitle');
    const terminalsLoading = document.getElementById('terminalsLoading');
    const terminalsList = document.getElementById('terminalsList');

    // Delete Modal Functionality
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const modalRegionName = document.getElementById('modalRegionName');
    let deleteUrl = '';

    // Add click event to all delete buttons
    document.querySelectorAll('.delete-region-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const regionName = this.getAttribute('data-region-name');
        deleteUrl = this.getAttribute('data-delete-url');
        
        modalRegionName.textContent = regionName;
        deleteModal.classList.add('active');
      });
    });

    // Cancel delete button
    cancelDeleteBtn.addEventListener('click', function() {
      deleteModal.classList.remove('active');
      deleteUrl = '';
    });

    // Confirm delete button
    confirmDeleteBtn.addEventListener('click', function() {
      if (deleteUrl) {
        window.location.href = deleteUrl;
      }
    });

    // Close delete modal when clicking outside
    deleteModal.addEventListener('click', function(e) {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
        deleteUrl = '';
      }
    });

    // Close delete modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && deleteModal.classList.contains('active')) {
        deleteModal.classList.remove('active');
        deleteUrl = '';
      }
    });

    // Close terminals modal when clicking X
    closeBtn.onclick = function() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Close terminals modal when clicking outside
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    // Close terminals modal with Escape key (only if delete modal is not active)
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal.style.display === 'block' && !deleteModal.classList.contains('active')) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // Handle region link clicks
    document.querySelectorAll('.region-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const regionId = this.dataset.regionId;
            const zonesContainer = document.getElementById(`zones-${regionId}`);
            
            // Toggle zones visibility
            if (zonesContainer.style.display === 'none') {
                // Hide all other zones first
                document.querySelectorAll('.zones-container').forEach(container => {
                    container.style.display = 'none';
                });
                
                // Load and show this region's zones
                loadZones(regionId, zonesContainer);
            } else {
                zonesContainer.style.display = 'none';
            }
        });
    });

    // Load zones for a region
    function loadZones(regionId, container) {
        container.innerHTML = '<div class="zones-loading"><i class="fas fa-spinner fa-spin"></i> Loading zones...</div>';
        container.style.display = 'block';

        fetch(`/get_zones/${regionId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Zones data received:', data);
                
                if (data.error) {
                    container.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</div>`;
                    return;
                }
                
                if (data.zones && data.zones.length > 0) {
                    let zonesHtml = '<div class="zones-list">';
                    data.zones.forEach(zone => {
                        zonesHtml += `
                            <div class="zone-item">
                                <a href="#" class="zone-link" data-zone-id="${zone.id}" data-zone-name="${zone.name}">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${zone.name}</span>
                                    <span class="terminal-count">
                                        <i class="fas fa-server"></i> ${zone.terminal_count}
                                    </span>
                                </a>
                            </div>
                        `;
                    });
                    zonesHtml += '</div>';
                    container.innerHTML = zonesHtml;

                    // Attach click handlers to zone links
                    container.querySelectorAll('.zone-link').forEach(zoneLink => {
                        zoneLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            const zoneId = this.dataset.zoneId;
                            const zoneName = this.dataset.zoneName;
                            openTerminalsModal(zoneId, zoneName);
                        });
                    });
                } else {
                    container.innerHTML = `
                        <div class="no-zones">
                            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <p>No zones found in this region.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">
                                <strong>Tip:</strong> Make sure zones are assigned to this region in the database.
                            </p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading zones:', error);
                container.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>Error loading zones: ${error.message}</p>
                        <p style="font-size: 0.9rem;">Check the browser console for more details.</p>
                    </div>
                `;
            });
    }

    // Open modal and load terminals for a zone
    function openTerminalsModal(zoneId, zoneName) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        modalTitle.innerHTML = `<i class="fas fa-desktop"></i> Terminals in ${zoneName}`;
        terminalsLoading.style.display = 'block';
        terminalsList.style.display = 'none';
        terminalsList.innerHTML = '';

        fetch(`/get_terminals/${zoneId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Terminals data received:', data);
                terminalsLoading.style.display = 'none';
                terminalsList.style.display = 'block';

                if (data.error) {
                    terminalsList.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</div>`;
                    return;
                }

                if (data.terminals && data.terminals.length > 0) {
                    let html = `
                        <div class="table-responsive">
                            <table class="terminals-table">
                                <thead>
                                    <tr>
                                        <th>Branch Name</th>
                                        <th>CDM Name</th>
                                        <th>Serial Number</th>
                                        <th>Model</th>
                                        <th>Customer</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.terminals.forEach(terminal => {
                        const statusClass = terminal.is_active ? 'active' : 'inactive';
                        const statusText = terminal.is_active ? 'Active' : 'Inactive';
                        const statusIcon = terminal.is_active ? 'fa-check-circle' : 'fa-times-circle';

                        html += `
                            <tr class="terminal-table-row">
                                <td><i class="fas fa-building"></i> ${terminal.branch_name}</td>
                                <td>${terminal.cdm_name}</td>
                                <td>${terminal.serial_number}</td>
                                <td>${terminal.model}</td>
                                <td>${terminal.customer_name || 'N/A'}</td>
                                <td>
                                    <span class="status-badge ${statusClass}">
                                        <i class="fas ${statusIcon}"></i> ${statusText}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    terminalsList.innerHTML = html;
                } else {
                    terminalsList.innerHTML = `
                        <div class="no-terminals">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>No terminals found in this zone.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading terminals:', error);
                terminalsLoading.style.display = 'none';
                terminalsList.style.display = 'block';
                terminalsList.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>Error loading terminals: ${error.message}</p>
                        <p style="font-size: 0.9rem;">Check the browser console for more details.</p>
                    </div>
                `;
            });
    }
});
</script>
{% endblock %}
