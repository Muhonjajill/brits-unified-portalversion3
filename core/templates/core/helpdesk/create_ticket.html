{% extends "base.html" %}
{% load static %}

{% block title %}Create New Ticket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/create_ticket.css' %}">
<link rel="stylesheet" href="{% static 'css/searchable-select.css' %}">
{% endblock %}

{% block content %}
<div class="form-wrapper">

    <h2>Create New Ticket</h2>

    {% if form.errors %}
    <div class="form-errors">
        <ul>
            {% for field in form %}
                {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" class="ticket-form">
        {% csrf_token %}

        <div class="form-grid">

            <!-- LEFT COLUMN -->
            <div class="form-column">

                <div class="form-group">
                    <label for="{{ form.brts_unit.id_for_label }}">BRTS Unit</label>
                    {{ form.brts_unit }}
                </div>

                <div class="form-group">
                    <label for="{{ form.problem_category.id_for_label }}">Problem Category</label>
                    <div class="searchable-select-wrapper" data-target="id_problem_category">
                        <input type="text" 
                            class="search-input" 
                            placeholder="Click ▼ or type here to search..."
                            autocomplete="off">
                        <span class="dropdown-icon">▼</span>
                        <div class="options-list"></div>
                    </div>
                    <!-- Hide the actual select -->
                    <div style="display: none;">
                        {{ form.problem_category }}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.status.id_for_label }}">Status</label>
                    {{ form.status }}
                </div>

                <div class="form-group">
                    <label for="{{ form.custom_created_at.id_for_label }}">Ticket Date (optional)</label>
                    {{ form.custom_created_at }}
                </div>

            </div>

            <!-- RIGHT COLUMN -->
            <div class="form-column">

                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}">Issue</label>
                    {{ form.title }}
                </div>

                <div class="form-group">
                    <label for="id_terminal">Terminal</label>
                    {% if form.fields.terminal.widget.attrs.readonly %}
                        <!-- Custodian: Show readonly terminal field -->
                        <select name="terminal" id="id_terminal" class="form-control" style="pointer-events: none; background-color: #e9ecef;">
                            {% for terminal in form.fields.terminal.queryset %}
                            <option value="{{ terminal.id }}" selected>
                                {{ terminal.branch_name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <!-- Others: Show searchable terminal field -->
                        <div class="searchable-select-wrapper" data-target="id_terminal">
                            <input type="text" 
                                class="search-input" 
                                placeholder="Click ▼ or type here to search..."
                                autocomplete="off">
                            <span class="dropdown-icon">▼</span>
                            <div class="options-list"></div>
                        </div>
                        <!-- Hide the actual select -->
                        <select name="terminal" id="id_terminal" class="form-control" style="display: none;">
                            <option value="" selected disabled>-- Select a Terminal --</option>
                            {% for terminal in form.fields.terminal.queryset %}
                            <option value="{{ terminal.id }}"
                                {% if form.fields.terminal.initial and form.fields.terminal.initial.id == terminal.id %}selected{% endif %}
                                {% if not terminal.is_active %}disabled style="color: grey;"{% endif %}>
                                {{ terminal.branch_name }}{% if not terminal.is_active %} (Inactive){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.customer.id_for_label }}">Customer</label>
                    {% if form.fields.customer.widget.attrs.disabled %}
                        <!-- Custodian/Overseer: Show readonly customer field -->
                        <select name="customer" id="id_customer" class="form-control" disabled style="background-color: #e9ecef;">
                            {% for customer in form.fields.customer.queryset %}
                            <option value="{{ customer.id }}" selected>
                                {{ customer.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <!-- Hidden field to ensure value is submitted -->
                        <input type="hidden" name="customer" value="{{ form.fields.customer.initial.id }}">
                    {% else %}
                        {{ form.customer }}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.region.id_for_label }}">Region</label>
                    {% if form.fields.region.widget.attrs.disabled %}
                        <!-- Custodian: Show readonly region field -->
                        <select name="region" id="id_region" class="form-control" disabled style="background-color: #e9ecef;">
                            {% for region in form.fields.region.queryset %}
                            <option value="{{ region.id }}" selected>
                                {{ region.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <!-- Hidden field to ensure value is submitted -->
                        <input type="hidden" name="region" value="{{ form.fields.region.initial.id }}">
                    {% else %}
                        {{ form.region }}
                    {% endif %}
                </div>

                {% if is_manager or is_staff %}
                <div class="form-group">
                    <label for="assigned_to">Assign To</label>
                    <select name="assigned_to" id="assigned_to" class="form-control">
                        <option value="">-- Select Staff --</option>
                        {% for staff in assignable_users %}
                            <option value="{{ staff.id }}">
                                {{ staff.get_full_name|default:staff.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

            </div>

        </div>

        <div class="form-group">
            <label for="{{ form.description.id_for_label }}">Description</label>
            {{ form.description }}
        </div>

        <div class="form-actions">
            <button type="submit" name="create" class="btn btn-primary">Create</button>
            <!--<button type="submit" name="create_another" class="btn btn-outline">Create & Add Another</button>-->
            <a href="{% url 'tickets' %}" class="btn btn-cancel">Cancel</a>
        </div>

    </form>


    
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loader-box">
        <div class="spinner">
            <div class="spinner-inner">
                <div class="spinner-circle"></div>
                <div class="spinner-circle"></div>
                <div class="spinner-circle"></div>
            </div>
        </div>
        <p class="loading-text">Creating ticket...</p>
        <div class="success hidden">
            <div class="checkmark">✓</div>
            <p>Ticket created successfully</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/searchable-select.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const categorySelect = document.getElementById("id_problem_category");
    const issueSelect    = document.getElementById("id_title");  
    const terminalSelect = document.getElementById("id_terminal");
    const customerSelect = document.getElementById("id_customer");
    const regionSelect   = document.getElementById("id_region");
    const datetimeInput  = document.getElementById("id_custom_created_at");

    const form = document.querySelector(".ticket-form");
    const overlay = document.getElementById("loadingOverlay");
    const spinner = overlay.querySelector(".spinner");
    const loadingText = overlay.querySelector(".loading-text");
    const success = overlay.querySelector(".success");

    overlay.classList.add("hidden");

    if (datetimeInput) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const currentDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        datetimeInput.setAttribute('placeholder', currentDateTime);
        
        datetimeInput.setAttribute('max', currentDateTime);
    }

    if (terminalSelect) {
        // Check if terminal is readonly (custodian) - don't attach change listener
        const isReadonly = terminalSelect.hasAttribute('readonly') || 
                          terminalSelect.style.pointerEvents === 'none';
        
        if (!isReadonly) {
            terminalSelect.addEventListener('change', function() {
                const terminalId = terminalSelect.value;
                if (terminalId) {
                    fetch(`/get_terminal_details/${terminalId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (customerSelect) customerSelect.value = data.customer_id || "";
                            if (regionSelect) regionSelect.value = data.region_id || "";
                        });
                }
            });
        }
    }

    const issueMapping = {{ issue_mapping|safe }};
    
    function populateIssues(catPk) {
        issueSelect.innerHTML = `<option value="">Select Issue</option>`;
        if (catPk && issueMapping[catPk]) {
            issueMapping[catPk].forEach(issue => {
                const o = new Option(issue, issue);
                issueSelect.append(o);
            });
            issueSelect.disabled = false;
        } else {
            issueSelect.disabled = true;
        }
    }

    if (categorySelect) {
        populateIssues(categorySelect.value);
        categorySelect.addEventListener("change", e => populateIssues(e.target.value));
    }

    if (!form) return;

    form.addEventListener("submit", (event) => {
        event.preventDefault();

        overlay.classList.remove("hidden");
        spinner.classList.remove("hidden");
        loadingText.classList.remove("hidden");
        success.classList.add("hidden");

        form.querySelectorAll("button").forEach(btn => btn.disabled = true);

        setTimeout(() => {
            form.submit();  
        }, 300);
    });

    {% if ticket_created %}
        overlay.classList.remove("hidden");
        spinner.classList.add("hidden");
        loadingText.classList.add("hidden");
        success.classList.remove("hidden");

        setTimeout(() => {
            overlay.classList.add("hidden");
        }, 2000);
    {% endif %}
});
</script>

<script src="{% static 'js/ticketing_dashboard.js' %}"></script>
{% endblock %}